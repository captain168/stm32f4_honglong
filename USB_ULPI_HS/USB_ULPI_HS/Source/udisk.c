/**
* @file          usbfunc_demoapp_disk.c
* @brief         disk module
* @author        Fe.M
* @version       1.0
* @date          2012/08/20
*               
**/

/*----------------------------------------------------------------------------*/
/*  Headers                                                                   */
/*----------------------------------------------------------------------------*/


#include "udisk.h"
#include "string.h"

/*----------------------------------------------------------------------------*/
/*  Constant Definition                                                       */
/*----------------------------------------------------------------------------*/
/* the max lun number setting(alternative value:1 to 16) */
#define MAX_LUN                  (USBF_MSC_LUN_NUM)

#define LB_NUM_INDEX        (0)     /* logical block number index */
#define LB_LEN_INDEX        (1)     /* logical block length index */

/* medium status */
#define MEDIA_UNIT_STATUS_GOOD                                                  (0x00) /* good status */
#define MEDIA_UNIT_STATUS_LOGICAL_UNIT_NOT_SUPPORTED                            (0x01) /* logical unit not be supported status */
#define MEDIA_UNIT_STATUS_LOGICAL_UNIT_DOES_NOT_RESPOND_TO_SELECTION            (0x02) /* logical unit does not respond to selection status */
#define MEDIA_UNIT_STATUS_MEDIUM_NOT_PRESENT                                    (0x03) /* medium not present status */
#define MEDIA_UNIT_STATUS_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE           (0x04) /* logical unit not ready cause not reportable status */
#define MEDIA_UNIT_STATUS_LOGICAL_UNIT_IS_IN_PROCESS_OF_BECOMING_READY          (0x05) /* logical unit is in process_of becoming ready status */
#define MEDIA_UNIT_STATUS_LOGICAL_UNIT_NOT_READY_INITIALIZING_COMMAND_REQUIRED  (0x06) /* logical unit not ready initializing command required status */
#define MEDIA_UNIT_STATUS_LOGICAL_UNIT_NOT_READY_MANUAL_INTERVENTION_REQUIRED   (0x07) /* logical unit not ready manual intervention required status */
#define MEDIA_UNIT_STATUS_LOGICAL_UNIT_NOT_READY_FORMAT_IN_PROGRESS             (0x08) /* logical unit not ready format in progress status */

/* medium status setting */
#define MEDIA_UNIT_STATUS             (MEDIA_UNIT_STATUS_GOOD)

/*----------------------------------------------------------------------------*/
/*  Configuration                                                             */
/*----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------*/
/*  Static Variable Definition                                                */
/*----------------------------------------------------------------------------*/
/* block information */
static uint32_t Blockinfo[1][2] = {
    {48,512U},
};

/* disk capacity */
uint8_t U_DISK[1024*24];

/* dbr information */
static uint8_t Dbr[512]=
{
/*  0x00  0x01  0x02  0x03  0x04  0x05  0x06  0x07  0x08  0x09  0x0A  0x0B  0x0C  0x0D  0x0E  0x0F */
//     0xEB, 0x3C, 0x90, 0x4D, 0x53, 0x44, 0x4F, 0x53, 0x35, 0x2E, 0x30, 0x00, 0x02, 0x01, 0x06, 0x00, /*00X*/
//     0x02, 0x10, 0x00, 0x30, 0x00, 0xF8, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, /*01X*/
//     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x29, 0x45, 0xBD, 0x71, 0x72, 0x4E, 0x4F, 0x20, 0x4E, 0x41, /*02X*/
//     0x4D, 0x45, 0x20, 0x20, 0x20, 0x20, 0x46, 0x41, 0x54, 0x31, 0x32, 0x20, 0x20, 0x20, 0x33, 0xC9, /*03X*/
//     0x8E, 0xD1, 0xBC, 0xF0, 0x7B, 0x8E, 0xD9, 0xB8, 0x00, 0x20, 0x8E, 0xC0, 0xFC, 0xBD, 0x00, 0x7C, /*04X*/
//     0x38, 0x4E, 0x24, 0x7D, 0x24, 0x8B, 0xC1, 0x99, 0xE8, 0x3C, 0x01, 0x72, 0x1C, 0x83, 0xEB, 0x3A, /*05X*/
//     0x66, 0xA1, 0x1C, 0x7C, 0x26, 0x66, 0x3B, 0x07, 0x26, 0x8A, 0x57, 0xFC, 0x75, 0x06, 0x80, 0xCA, /*06X*/
//     0x02, 0x88, 0x56, 0x02, 0x80, 0xC3, 0x10, 0x73, 0xEB, 0x33, 0xC9, 0x8A, 0x46, 0x10, 0x98, 0xF7, /*07X*/
//     0x66, 0x16, 0x03, 0x46, 0x1C, 0x13, 0x56, 0x1E, 0x03, 0x46, 0x0E, 0x13, 0xD1, 0x8B, 0x76, 0x11, /*08X*/
//     0x60, 0x89, 0x46, 0xFC, 0x89, 0x56, 0xFE, 0xB8, 0x20, 0x00, 0xF7, 0xE6, 0x8B, 0x5E, 0x0B, 0x03, /*09X*/
//     0xC3, 0x48, 0xF7, 0xF3, 0x01, 0x46, 0xFC, 0x11, 0x4E, 0xFE, 0x61, 0xBF, 0x00, 0x00, 0xE8, 0xE6, /*0AX*/
//     0x00, 0x72, 0x39, 0x26, 0x38, 0x2D, 0x74, 0x17, 0x60, 0xB1, 0x0B, 0xBE, 0xA1, 0x7D, 0xF3, 0xA6, /*0BX*/
//     0x61, 0x74, 0x32, 0x4E, 0x74, 0x09, 0x83, 0xC7, 0x20, 0x3B, 0xFB, 0x72, 0xE6, 0xEB, 0xDC, 0xA0, /*0CX*/
//     0xFB, 0x7D, 0xB4, 0x7D, 0x8B, 0xF0, 0xAC, 0x98, 0x40, 0x74, 0x0C, 0x48, 0x74, 0x13, 0xB4, 0x0E, /*0DX*/
//     0xBB, 0x07, 0x00, 0xCD, 0x10, 0xEB, 0xEF, 0xA0, 0xFD, 0x7D, 0xEB, 0xE6, 0xA0, 0xFC, 0x7D, 0xEB, /*0EX*/
//     0xE1, 0xCD, 0x16, 0xCD, 0x19, 0x26, 0x8B, 0x55, 0x1A, 0x52, 0xB0, 0x01, 0xBB, 0x00, 0x00, 0xE8, /*0FX*/
//     0x3B, 0x00, 0x72, 0xE8, 0x5B, 0x8A, 0x56, 0x24, 0xBE, 0x0B, 0x7C, 0x8B, 0xFC, 0xC7, 0x46, 0xF0, /*10X*/
//     0x3D, 0x7D, 0xC7, 0x46, 0xF4, 0x29, 0x7D, 0x8C, 0xD9, 0x89, 0x4E, 0xF2, 0x89, 0x4E, 0xF6, 0xC6, /*11X*/
//     0x06, 0x96, 0x7D, 0xCB, 0xEA, 0x03, 0x00, 0x00, 0x20, 0x0F, 0xB6, 0xC8, 0x66, 0x8B, 0x46, 0xF8, /*12X*/
//     0x66, 0x03, 0x46, 0x1C, 0x66, 0x8B, 0xD0, 0x66, 0xC1, 0xEA, 0x10, 0xEB, 0x5E, 0x0F, 0xB6, 0xC8, /*13X*/
//     0x4A, 0x4A, 0x8A, 0x46, 0x0D, 0x32, 0xE4, 0xF7, 0xE2, 0x03, 0x46, 0xFC, 0x13, 0x56, 0xFE, 0xEB, /*14X*/
//     0x4A, 0x52, 0x50, 0x06, 0x53, 0x6A, 0x01, 0x6A, 0x10, 0x91, 0x8B, 0x46, 0x18, 0x96, 0x92, 0x33, /*15X*/
//     0xD2, 0xF7, 0xF6, 0x91, 0xF7, 0xF6, 0x42, 0x87, 0xCA, 0xF7, 0x76, 0x1A, 0x8A, 0xF2, 0x8A, 0xE8, /*16X*/
//     0xC0, 0xCC, 0x02, 0x0A, 0xCC, 0xB8, 0x01, 0x02, 0x80, 0x7E, 0x02, 0x0E, 0x75, 0x04, 0xB4, 0x42, /*17X*/
//     0x8B, 0xF4, 0x8A, 0x56, 0x24, 0xCD, 0x13, 0x61, 0x61, 0x72, 0x0B, 0x40, 0x75, 0x01, 0x42, 0x03, /*18X*/
//     0x5E, 0x0B, 0x49, 0x75, 0x06, 0xF8, 0xC3, 0x41, 0xBB, 0x00, 0x00, 0x60, 0x66, 0x6A, 0x00, 0xEB, /*19X*/
//     0xB0, 0x4E, 0x54, 0x4C, 0x44, 0x52, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0D, 0x0A, 0x52, 0x65, /*1AX*/
//     0x6D, 0x6F, 0x76, 0x65, 0x20, 0x64, 0x69, 0x73, 0x6B, 0x73, 0x20, 0x6F, 0x72, 0x20, 0x6F, 0x74, /*1BX*/
//     0x68, 0x65, 0x72, 0x20, 0x6D, 0x65, 0x64, 0x69, 0x61, 0x2E, 0xFF, 0x0D, 0x0A, 0x44, 0x69, 0x73, /*1CX*/
//     0x6B, 0x20, 0x65, 0x72, 0x72, 0x6F, 0x72, 0xFF, 0x0D, 0x0A, 0x50, 0x72, 0x65, 0x73, 0x73, 0x20, /*1DX*/
//     0x61, 0x6E, 0x79, 0x20, 0x6B, 0x65, 0x79, 0x20, 0x74, 0x6F, 0x20, 0x72, 0x65, 0x73, 0x74, 0x61, /*1EX*/
//     0x72, 0x74, 0x0D, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xAC, 0xCB, 0xD8, 0x55, 0xAA  /*1FX*/
0xEB, 0x3C, 0x90, 0x4D, 0x53, 0x44, 0x4F, 0x53, 0x35, 0x2E, 0x30, 0x00, 0x02, 0x01, 0x06, 0x00, 
	0x02, 0x10, 0x00, 0x30, 0x00, 0xF8, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x29, 0x45, 0xBD, 0x71, 0x72, 0x4E, 0x4F, 0x20, 0x4E, 0x41, 
	0x4D, 0x45, 0x20, 0x20, 0x20, 0x20, 0x46, 0x41, 0x54, 0x31, 0x32, 0x20, 0x20, 0x20, 0x33, 0xC9, 
	0x8E, 0xD1, 0xBC, 0xF0, 0x7B, 0x8E, 0xD9, 0xB8, 0x00, 0x20, 0x8E, 0xC0, 0xFC, 0xBD, 0x00, 0x7C, 
	0x38, 0x4E, 0x24, 0x7D, 0x24, 0x8B, 0xC1, 0x99, 0xE8, 0x3C, 0x01, 0x72, 0x1C, 0x83, 0xEB, 0x3A, 
	0x66, 0xA1, 0x1C, 0x7C, 0x26, 0x66, 0x3B, 0x07, 0x26, 0x8A, 0x57, 0xFC, 0x75, 0x06, 0x80, 0xCA, 
	0x02, 0x88, 0x56, 0x02, 0x80, 0xC3, 0x10, 0x73, 0xEB, 0x33, 0xC9, 0x8A, 0x46, 0x10, 0x98, 0xF7, 
	0x66, 0x16, 0x03, 0x46, 0x1C, 0x13, 0x56, 0x1E, 0x03, 0x46, 0x0E, 0x13, 0xD1, 0x8B, 0x76, 0x11, 
	0x60, 0x89, 0x46, 0xFC, 0x89, 0x56, 0xFE, 0xB8, 0x20, 0x00, 0xF7, 0xE6, 0x8B, 0x5E, 0x0B, 0x03, 
	0xC3, 0x48, 0xF7, 0xF3, 0x01, 0x46, 0xFC, 0x11, 0x4E, 0xFE, 0x61, 0xBF, 0x00, 0x00, 0xE8, 0xE6, 
	0x00, 0x72, 0x39, 0x26, 0x38, 0x2D, 0x74, 0x17, 0x60, 0xB1, 0x0B, 0xBE, 0xA1, 0x7D, 0xF3, 0xA6, 
	0x61, 0x74, 0x32, 0x4E, 0x74, 0x09, 0x83, 0xC7, 0x20, 0x3B, 0xFB, 0x72, 0xE6, 0xEB, 0xDC, 0xA0, 
	0xFB, 0x7D, 0xB4, 0x7D, 0x8B, 0xF0, 0xAC, 0x98, 0x40, 0x74, 0x0C, 0x48, 0x74, 0x13, 0xB4, 0x0E, 
	0xBB, 0x07, 0x00, 0xCD, 0x10, 0xEB, 0xEF, 0xA0, 0xFD, 0x7D, 0xEB, 0xE6, 0xA0, 0xFC, 0x7D, 0xEB, 
	0xE1, 0xCD, 0x16, 0xCD, 0x19, 0x26, 0x8B, 0x55, 0x1A, 0x52, 0xB0, 0x01, 0xBB, 0x00, 0x00, 0xE8, 
	0x3B, 0x00, 0x72, 0xE8, 0x5B, 0x8A, 0x56, 0x24, 0xBE, 0x0B, 0x7C, 0x8B, 0xFC, 0xC7, 0x46, 0xF0, 
	0x3D, 0x7D, 0xC7, 0x46, 0xF4, 0x29, 0x7D, 0x8C, 0xD9, 0x89, 0x4E, 0xF2, 0x89, 0x4E, 0xF6, 0xC6, 
	0x06, 0x96, 0x7D, 0xCB, 0xEA, 0x03, 0x00, 0x00, 0x20, 0x0F, 0xB6, 0xC8, 0x66, 0x8B, 0x46, 0xF8, 
	0x66, 0x03, 0x46, 0x1C, 0x66, 0x8B, 0xD0, 0x66, 0xC1, 0xEA, 0x10, 0xEB, 0x5E, 0x0F, 0xB6, 0xC8, 
	0x4A, 0x4A, 0x8A, 0x46, 0x0D, 0x32, 0xE4, 0xF7, 0xE2, 0x03, 0x46, 0xFC, 0x13, 0x56, 0xFE, 0xEB, 
	0x4A, 0x52, 0x50, 0x06, 0x53, 0x6A, 0x01, 0x6A, 0x10, 0x91, 0x8B, 0x46, 0x18, 0x96, 0x92, 0x33, 
	0xD2, 0xF7, 0xF6, 0x91, 0xF7, 0xF6, 0x42, 0x87, 0xCA, 0xF7, 0x76, 0x1A, 0x8A, 0xF2, 0x8A, 0xE8, 
	0xC0, 0xCC, 0x02, 0x0A, 0xCC, 0xB8, 0x01, 0x02, 0x80, 0x7E, 0x02, 0x0E, 0x75, 0x04, 0xB4, 0x42, 
	0x8B, 0xF4, 0x8A, 0x56, 0x24, 0xCD, 0x13, 0x61, 0x61, 0x72, 0x0B, 0x40, 0x75, 0x01, 0x42, 0x03, 
	0x5E, 0x0B, 0x49, 0x75, 0x06, 0xF8, 0xC3, 0x41, 0xBB, 0x00, 0x00, 0x60, 0x66, 0x6A, 0x00, 0xEB, 
	0xB0, 0x4E, 0x54, 0x4C, 0x44, 0x52, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0D, 0x0A, 0x52, 0x65, 
	0x6D, 0x6F, 0x76, 0x65, 0x20, 0x64, 0x69, 0x73, 0x6B, 0x73, 0x20, 0x6F, 0x72, 0x20, 0x6F, 0x74, 
	0x68, 0x65, 0x72, 0x20, 0x6D, 0x65, 0x64, 0x69, 0x61, 0x2E, 0xFF, 0x0D, 0x0A, 0x44, 0x69, 0x73, 
	0x6B, 0x20, 0x65, 0x72, 0x72, 0x6F, 0x72, 0xFF, 0x0D, 0x0A, 0x50, 0x72, 0x65, 0x73, 0x73, 0x20, 
	0x61, 0x6E, 0x79, 0x20, 0x6B, 0x65, 0x79, 0x20, 0x74, 0x6F, 0x20, 0x72, 0x65, 0x73, 0x74, 0x61, 
	0x72, 0x74, 0x0D, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xAC, 0xCB, 0xD8, 0x55, 0xAA
};

/* fat table */
static uint8_t Fat[4]={0xF8, 0xFF, 0xFF, 0xFF};

/*----------------------------------------------------------------------------*/
/*  Functions                                                                 */
/*----------------------------------------------------------------------------*/
/**
* @brief             format disk
*
* @param             none
* @return            none
*
**/
void disk_format(void)
{
    /* clear disk */
    memset(U_DISK, '\0', sizeof(U_DISK));

    /* set dbr on disk's first sector */
    memcpy(&U_DISK[512 * 0], Dbr, 512);

    /* set FAT on disk's second sector */
    memcpy(&U_DISK[512 * 1], Fat, 4);

    /* set FAT on disk's third sector */
    memcpy(&U_DISK[512 * 2], Fat, 4);

    return;
}

/**
* @brief             read data from disk
*
* @param             lun  : logical unit number
* @param             lba  : logical block address
* @param             addr : pointer to address
* @return            TRUE  : sucessfully complete
* @return            FALSE : process failed
*
**/
// uint8_t disk_read_logical_block(uint8_t lun, uint32_t lba, const uint8_t *addr)
// {
//     uint8_t ret;    /* return value */
//     uint32_t block_length;  /* block length */

//     /* logical unit number is correct */
//     if (lun < MAX_LUN)
//     {
//         /* get block length from logical block information */
//         block_length = Blockinfo[lun][LB_LEN_INDEX];
//         /* set data to appointed address */
//         (void)memcpy((void *)addr, &U_DISK[lba*block_length], block_length);
//         ret = TRUE;
//     }
//     else
//     {
//         /* set return value to false */
//         ret = FALSE;
//     }

//     return (ret);

// }

/**
* @brief             write data to disk
*
* @param             lun  : logical unit number
* @param             lba  : logical block address
* @param             addr : pointer to address
* @return            TRUE  : sucessfully complete
* @return            FALSE : process failed
*
**/
// uint8_t disk_write_logical_block(uint8_t lun, uint32_t lba, const uint8_t *addr)
// {
//     uint8_t ret;    /* return value */
//     uint32_t block_length;  /* block length */

//     /* logical unit number is correct */
//     if (lun < MAX_LUN)
//     {
//         /* get block length from logical block information */
//         block_length = Blockinfo[lun][LB_LEN_INDEX];
//         /* set data to appointed address */
//         (void)memcpy(&U_DISK[lba*block_length], (void *)addr, block_length);
//         ret = TRUE;
//     }
//     else
//     {
//         /* set return value to false */
//         ret = FALSE;
//     }

//     return (ret);

// }

/**
* @brief             get logical block information
*
* @param             lun          : logical unit number
* @param             lun_data_ptr : pointer to logical unit information
* @return            TRUE  : sucessfully complete
* @return            FALSE : process failed
*
**/
// uint8_t disk_get_logical_block_info(uint8_t lun, USBF_MSC_ST_LUN_DATA *lun_data_ptr)
// {
//     uint8_t ret;  /* return value */

//      /* logical unit number is correct */
//     if (lun < MAX_LUN)
//     {
//         /* set logical block information */
//         lun_data_ptr->BlockNum    = Blockinfo[lun][LB_NUM_INDEX];
//         lun_data_ptr->BlockSize   = Blockinfo[lun][LB_LEN_INDEX];
//         lun_data_ptr->MediaStatus = MEDIA_UNIT_STATUS;
//         ret = TRUE;
//     }
//     else
//     {
//         /* set return value to false */
//         ret = FALSE;
//     }
//     return (ret);
// }

/**
* @brief             process disk event
*
* @param             lun        : logical unit number
* @param             event_type : event type
* @param             event_info : pointer to event information
* @return            TRUE  : sucessfully complete
*
**/
// uint8_t disk_event(uint8_t lun, uint16_t event_type, void* event_info)
// {
//     switch (event_type)
//     {
//         /* cache information setting event */
//         case USBF_MSC_MEDIUM_EVENT_SET_CACHE_INFO:

//             break;

//         /* power condition setting event */
//         case USBF_MSC_MEDIUM_EVENT_SET_POWER_CONDITION:

//             break;

//         /* medium removal setting event */
//         case USBF_MSC_MEDIUM_EVENT_SET_REMOVAL:

//             break;

//         /* verify setting event */
//         case USBF_MSC_MEDIUM_EVENT_VERIFY:

//             break;

//         /* other event */
//         default :
//             break;
//     }

//     return (TRUE);
// }
//ÐéÄâ´æ´¢Æ÷³õÊ¼»¯
void DiskInit(void)
 {
	 //uint32_t i;
	 disk_format();
	   //for (i = 0; i <1024*24;  i++) {     /* Copy Initial Disk Image */
    //Memory[i] = U_DISK[i];               /*   from Flash to RAM     */
  }
	 
 //}
